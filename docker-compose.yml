version: "3.8"

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: microservices-sqlserver
    environment:
      SA_PASSWORD: "${SA_PASSWORD}"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
    ports:
      - "${SQL_SERVER_PORT}:1433"
    volumes:
      - sql_data:/var/opt/mssql
      - ./init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    networks:
      - microservices-network
    command: >
      /bin/bash -c "
      /opt/mssql/bin/sqlservr &
      sleep 30 &&
      /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${SA_PASSWORD} -C -i /docker-entrypoint-initdb.d/init-databases.sql &&
      wait
      "
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${SA_PASSWORD} -C -Q "SELECT 1 FROM sys.databases WHERE name IN ('AuthDb', 'OrderServiceDB')" || exit 1
      interval: 10s
      timeout: 3s
      retries: 15
      start_period: 50s

  authservice:
    build:
      context: ./AuthService
      dockerfile: Dockerfile
    container_name: authservice
    ports:
      - "${AUTH_SERVICE_PORT}:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__AuthDb=Server=sqlserver,1433;Database=AuthDb;User Id=${DB_USERNAME};Password=${SA_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - JwtSettings__ExpirationMinutes=${JWT_EXPIRATION_MINUTES}
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  orderservice:
    build:
      context: ./OrderService
      dockerfile: Dockerfile
    container_name: orderservice
    ports:
      - "${ORDER_SERVICE_PORT}:80"
    environment:
      - DB_CONNECTION=${DB_CONNECTION}
      - DB_HOST=sqlserver
      - DB_PORT=1433
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${SA_PASSWORD}
      - DB_TRUST_SERVER_CERTIFICATE=true
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=${JWT_ISSUER}
      - JWT_AUDIENCE=${JWT_AUDIENCE}
    depends_on:
      sqlserver:
        condition: service_healthy
      authservice:
        condition: service_started
    networks:
      - microservices-network
    restart: unless-stopped

  frontend:
    build:
      context: ./FrontendApp
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - authservice
      - orderservice
    networks:
      - microservices-network
    restart: unless-stopped

networks:
  microservices-network:
    driver: bridge

volumes:
  sql_data:
